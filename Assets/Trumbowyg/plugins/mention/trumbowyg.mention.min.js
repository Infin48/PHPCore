var mentionUserList=mentionUserList,trumbowygEditor="";function getSelectionCoords(e){var t,n,o,r=(e=e||window).document,i=r.selection,a=0,s=0;if(i)"Control"!=i.type&&((t=i.createRange()).collapse(!0),a=t.boundingLeft,s=t.boundingTop);else if(e.getSelection&&(i=e.getSelection()).rangeCount&&((t=i.getRangeAt(0).cloneRange()).getClientRects&&(t.collapse(!0),(n=t.getClientRects()).length>0&&(o=n[0]),o?(a=o.left,s=$(window).scrollTop()+o.top):(a=0,s=0)),0==a&&0==s)){var l=r.createElement("span");if(l.getClientRects){l.appendChild(r.createTextNode("​")),t.insertNode(l),a=(o=l.getClientRects()[0]).left,s=o.top;var c=l.parentNode;c.removeChild(l),c.normalize()}}return{x:a,y:s}}function getCaretCharacterOffsetWithin(e){var t,n=0,o=e.ownerDocument||e.document,r=o.defaultView||o.parentWindow;if(void 0!==r.getSelection){if((t=r.getSelection()).rangeCount>0){var i=r.getSelection().getRangeAt(0),a=i.cloneRange();a.selectNodeContents(e),a.setEnd(i.endContainer,i.endOffset),n=a.toString().length}}else if((t=o.selection)&&"Control"!=t.type){var s=t.createRange(),l=o.body.createTextRange();l.moveToElementText(e),l.setEndPoint("EndToEnd",s),n=l.text.length}return n}function getCaretPosition(){if(window.getSelection&&window.getSelection().getRangeAt){for(var e=window.getSelection().getRangeAt(0),t=window.getSelection(),n=0,o=t.anchorNode.parentNode.childNodes,r=0;r<o.length&&o[r]!=t.anchorNode;r++)o[r].outerHTML?n+=o[r].outerHTML.length:3==o[r].nodeType&&(n+=o[r].textContent.length);return e.startOffset+n}return -1}!function(e){"use strict";var t=[],n=0,o='[js="mention-list"]',r="";e.extend(!0,e.trumbowyg,{langs:{en:{empty:"No results"},cs:{empty:"Ž\xe1dn\xe9 v\xfdsledky"},sk:{empty:"Žiadne v\xfdsledky"}},plugins:{mention:{init:function(i){mentionUserList&&(t.length||e.each(mentionUserList,function(e,n){t.push(e)}),e(o).length||(e("body").append('<div class="mention-list" js="mention-list"></div>'),r=e(o)),e(function(){e(document).on("click","a[mention]",function(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();var o=trumbowygEditor.html(),i=e(this).attr("mention-replace"),a=e(this).attr("mention-name"),s=RegExp(i,"g");if(!(o.match(s).length>=2)){var l="";mentionUserList[a].link&&(l=' href="'+mentionUserList[a].link+'"');var c='<a class="mention {class}" mention="{user_name}" {href} contenteditable="false">@{user_name}</a>&nbsp;'.replace(/{class}/g,mentionUserList[a].class?" "+mentionUserList[a].class:"");c=(c=c.replace(/{href}/g,l)).replace(/{user_name}/g,a);var s=RegExp(""+i,"g");o=o.replace(s,c),trumbowygEditor.html(o),n=0,r.hide()}}),i.$box.on("mouseup",function(){r.hide(),n=0}),i.$ed.on("keyup",function(e){if(trumbowygEditor=i.$ed,27==e.keyCode||32==e.keyCode||38==e.keyCode||40==e.keyCode||39==e.keyCode||37==e.keyCode){if(27==e.keyCode){r.hide();return}n=0,r.hide();return}var o=i.$ed.text(),a=getCaretCharacterOffsetWithin(i.$ed[0]);if(n>a||n==a+1&&8==e.keyCode){n=0,r.hide();return}if("@"==o.substring(a-1,a)&&(n=a),0==n||(o=o.substring(n,n+a-n)).length<=2){r.hide();return}r.html("");var s="@"+o;o=o.toLowerCase();var l=t.filter(function(e){var t=RegExp(e.toLowerCase(),"g"),n=trumbowygEditor.html().match(t);if(null==n||!(n.length>=2))return(e=e.toLowerCase()).indexOf(o)>=0});if(0==l.length){var c=getSelectionCoords();r.css({top:c.y+20+"px",left:c.x-20+"px"}),r.html('<a class="mention-empty">{lang_empty}</a>'.replace(/{lang_empty}/g,i.lang.empty)),r.show();return}l.forEach(function(e){var t=e;if(o.length>0){var n=RegExp(o,"i");t=t.replace(n,"<u>@"+o+"</u>")}var i="";mentionUserList[e].class&&(i='class="'+mentionUserList[e].class+'"'),r.append('<a mention {class} mention-name="{user_name}" mention-replace="{replace}">{user_name_underlined}</a>'.replace(/{user_name}/g,e).replace(/{class}/g,i).replace(/{replace}/g,s).replace(/{user_name_underlined}/g,t))});var c=getSelectionCoords();r.css({top:c.y+20+"px",left:c.x-20+"px"}),r.show()})}))}}}}),e(document).mouseup(function(e){r&&(r.is(e.target)||0!==r.has(e.target).length||r.hide())})}(jQuery);